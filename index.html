<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FocusEdu</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { midnight: '#0f172a', 'midnight-light': '#1e293b' },
                    screens: { 'xs': '475px' }
                }
            }
        }
    </script>

    <!-- Essential AI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd" crossorigin="anonymous"></script>

    <!-- App Logic -->
    <script>
        function studyApp() {
            return {
                darkMode: false,
                timeLeft: 25 * 60,
                effectiveTime: 0,
                selectedDuration: 25,
                timerRunning: false,
                timerInterval: null,
                videoType: 'youtube', 
                youtubeInput: '',
                currentYoutubeId: '', 
                showControls: true,
                cameraReady: false,
                currentStatus: 'Initializing AI...',
                isStudying: false,
                phoneDetected: false,
                userMissing: false,
                gazeDirection: 'Center',
                alertMessage: null, 
                alertType: '', 
                fadingMessage: null,
                lastFadingTime: 0,
                isFullscreen: false,
                
                motivationalTexts: [
                    "You are capable of amazing things.", "Believe in yourself.", "Focus on your goals.", "Dream big, study hard.", 
                    "Success is a series of small wins.", "Your potential is endless.", "Make it happen.", "Stay positive, work hard.", 
                    "Do it for your own self.", "Every session counts.", "Discipline is self-love.", "Fall in love with the process.", 
                    "You got this, girl!", "Starve your distractions.", "Feed your focus.", "Growth happens outside the comfort zone.", 
                    "Be the energy you want to attract.", "Study now, shine later.", "Productivity looks good on you.", 
                    "Create the life you can't wait to wake up to.", "Don't stop until you're proud.", "Little by little, one travels far.", 
                    "Focus is the new pretty.", "Your only limit is your mind.", "Work hard in silence, let success make the noise.",
                    "Be a goal digger.", "Smart is the new cool.", "Invest in your mind.", "Knowledge is power.", "Stay humble, hustle hard.",
                    "Good things take time.", "Keep going, you're getting there.", "Trust the timing of your life.", "Progress over perfection.", 
                    "You are building a masterpiece.", "The best view comes after the hardest climb.", "Motivation gets you started.", 
                    "Don't wish for it, work for it.", "Be so good they can't ignore you.", "Your future needs you.",
                    "Today is a great day to learn.", "Shine bright.", "Focus on the step in front of you.", "Keep your eyes on the stars.",
                    "You are stronger than you think.", "It always seems impossible until it's done.", "Start where you are.", 
                    "Success doesn't come to you, you go to it.", "Wake up with determination.", "Don't watch the clock; keep going.", 
                    "The secret of getting ahead is getting started.", "Quality over quantity.", "Study like there's no tomorrow.", 
                    "Be the girl who decided to go for it.", "Hustle and heart.", "Turning coffee into degrees.", "Romanticize your life.", 
                    "Visualize your highest self.", "Manifesting good grades.", "Clear mind, full heart.", "Breathe in confidence.", 
                    "You are magic.", "Self-discipline is self-love.", "Your ambition is your superpower.", "Glow through what you go through.", 
                    "Make your own luck.", "Preparation is key.", "Focus on the good.", "Positive mind, positive life.", 
                    "Be fearless.", "Success is not final.", "Everything you need is inside you.", "Be the CEO of your life.", 
                    "Empowered women empower women.", "Kindness and knowledge.", "Stay peachy.", "Bloom where you are planted.", 
                    "Radiate positivity.", "Choose to shine.", "Hard work beats talent.", "No substitute for hard work.", 
                    "Study hard, nap harder.", "Coffee and confidence.", "Learning is a treasure.", "Education is the passport.", 
                    "The fruit is sweet.", "Develop a passion for learning.", "The expert was once a beginner.", 
                    "No shortcuts to excellence.", "Genius is 99% perspiration.", "I am creating my dream life.", 
                    "My potential is limitless.", "I am focused.", "Every day I am smarter.", "I can handle this.", 
                    "I am worthy of my dreams.", "Success is my destiny.", "Just keep swimming."
                ],
                
                init() {
                    this.timeLeft = this.selectedDuration * 60;
                    setTimeout(() => this.startVisionSystem(), 1000);

                    // Listen for fullscreen change events to update icon
                    document.addEventListener('fullscreenchange', () => {
                        this.isFullscreen = !!document.fullscreenElement;
                    });
                },

                toggleTheme() { this.darkMode = !this.darkMode; },
                setDuration(min) {
                    this.selectedDuration = min;
                    this.timeLeft = min * 60;
                    this.timerRunning = false;
                    if (this.timerInterval) clearInterval(this.timerInterval);
                },

                toggleTimer() {
                    if (this.timerRunning) this.stopTimer();
                    else this.startTimer();
                },

                startTimer() {
                    if(!this.cameraReady) {
                        this.triggerAlert("Wait for AI to load... ‚ú®", "info");
                        return;
                    }
                    this.timerRunning = true;
                    this.showControls = false;
                    this.timerInterval = setInterval(() => {
                        if (!this.userMissing) {
                            if (this.timeLeft > 0) this.timeLeft--;
                            else this.finishSession();
                        }
                        if (this.isStudying && !this.phoneDetected && !this.userMissing) {
                            this.effectiveTime++;
                        }
                        this.updateMessages();
                    }, 1000);
                },

                stopTimer() {
                    this.timerRunning = false;
                    if (this.timerInterval) clearInterval(this.timerInterval);
                    this.alertMessage = null;
                    this.showControls = true;
                },

                finishSession() {
                    this.stopTimer();
                    const efficiency = ((this.effectiveTime / (this.selectedDuration * 60)) * 100).toFixed(1);
                    this.alertMessage = `Finished! Efficiency: ${efficiency}% üíñ`;
                    this.alertType = 'finished'; 
                },

                toggleFullscreen() {
                    const el = this.$refs.videoContainer;
                    if (!document.fullscreenElement) {
                        el.requestFullscreen().catch(err => {
                            console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                },

                formatTime(seconds) {
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                },

                loadYoutube() {
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                    const match = this.youtubeInput.match(regExp);
                    if (match && match[2].length === 11) this.currentYoutubeId = match[2];
                    else alert("Invalid YouTube URL üå∏");
                },

                handleFileUpload(e) {
                    const file = e.target.files[0];
                    if (file) this.$refs.uploadedVideo.src = URL.createObjectURL(file);
                },

                updateMessages() {
                    const now = Date.now();
                    if (this.userMissing) {
                        this.alertMessage = "Where did you go? ü•∫";
                        this.alertType = "missing";
                    } else if (this.phoneDetected) {
                        this.alertMessage = "No phone allowed! üìµ";
                        this.alertType = "phone";
                    } else if (this.gazeDirection === 'Side') { 
                        this.alertMessage = "Make each second worth it";
                        this.alertType = "distracted";
                    } else {
                        this.alertMessage = null;
                        if (this.isStudying && (now - this.lastFadingTime > 12000)) {
                            this.triggerFadingMessage(this.motivationalTexts[Math.floor(Math.random() * this.motivationalTexts.length)]);
                            this.lastFadingTime = now;
                        }
                    }
                },

                triggerFadingMessage(text) {
                    this.fadingMessage = null; 
                    setTimeout(() => { this.fadingMessage = text; }, 50);
                },

                triggerAlert(msg, type) {
                    this.alertMessage = msg;
                    this.alertType = type;
                    setTimeout(() => { if(this.alertType === 'info') this.alertMessage = null; }, 3000);
                },

                get statusColor() {
                    if (this.userMissing) return 'text-slate-400';
                    if (this.phoneDetected) return 'text-rose-400';
                    if (this.isStudying) return 'text-emerald-400';
                    return 'text-orange-400';
                },

                async startVisionSystem() {
                    const videoElement = document.getElementById('input-video');
                    
                    if (typeof Camera === 'undefined' || typeof FaceMesh === 'undefined' || typeof cocoSsd === 'undefined') {
                        setTimeout(() => this.startVisionSystem(), 1000);
                        return;
                    }

                    try {
                        const camera = new Camera(videoElement, {
                            onFrame: async () => {},
                            width: 640,
                            height: 360
                        });
                        await camera.start();
                    } catch (e) {
                        this.currentStatus = "Camera Error";
                        return;
                    }

                    const faceMesh = new FaceMesh({locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                    }});
                    
                    faceMesh.setOptions({
                        maxNumFaces: 1,
                        refineLandmarks: false,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });

                    faceMesh.onResults(this.onFaceResults.bind(this));

                    cocoSsd.load({ base: 'lite_mobilenet_v2' }).then(model => {
                        const detector = model;
                        this.cameraReady = true;
                        this.currentStatus = "Ready ‚ú®";

                        let frameCount = 0;
                        setInterval(async () => {
                            if (!this.cameraReady || videoElement.paused || videoElement.ended) return;
                            frameCount++;
                            try { await faceMesh.send({image: videoElement}); } catch(e) {}
                            
                            if (frameCount % 5 === 0) {
                                const predictions = await detector.detect(videoElement, 10, 0.50);
                                const phone = predictions.find(p => p.class === 'cell phone');
                                this.phoneDetected = !!phone;
                            }
                        }, 200);
                    });
                },

                onFaceResults(results) {
                    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                        this.userMissing = false;
                        const landmarks = results.multiFaceLandmarks[0];
                        const nose = landmarks[1];
                        const leftCheek = landmarks[234];
                        const rightCheek = landmarks[454];
                        const forehead = landmarks[10];
                        const chin = landmarks[152];

                        const yawRatio = Math.abs(nose.x - leftCheek.x) / (Math.abs(nose.x - leftCheek.x) + Math.abs(nose.x - rightCheek.x));
                        const pitchRatio = Math.abs(nose.y - forehead.y) / (Math.abs(nose.y - forehead.y) + Math.abs(nose.y - chin.y));

                        if (yawRatio < 0.28 || yawRatio > 0.72) {
                            this.gazeDirection = 'Side';
                            this.isStudying = false;
                            this.currentStatus = "Distracted";
                        } else if (pitchRatio > 0.75) {
                            this.gazeDirection = 'Down';
                            this.isStudying = true;
                            this.currentStatus = "Studying";
                        } else {
                            this.gazeDirection = 'Screen';
                            this.isStudying = true; 
                            this.currentStatus = "Watching";
                        }
                    } else {
                        this.userMissing = true;
                        this.isStudying = false;
                        this.currentStatus = "No User";
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <style>
        body {
            background-color: #fff1f2;
            background-image: radial-gradient(at 40% 20%, hsla(28,100%,74%,0.15) 0px, transparent 50%), radial-gradient(at 80% 0%, hsla(189,100%,56%,0.15) 0px, transparent 50%);
            font-family: 'Quicksand', sans-serif;
            transition: all 0.4s ease;
        }
        body.dark { background-color: #0f172a; color: #e2e8f0; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }
        body.dark .glass-panel { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.05); }
        .video-wrapper iframe, .video-wrapper video { width: 100%; height: 100%; object-fit: cover; border-radius: 24px; }
        /* Reset border radius in fullscreen to fill corners */
        :fullscreen .video-wrapper iframe, :fullscreen .video-wrapper video { border-radius: 0; }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        .animate-message { animation: fadeInOut 4s ease-in-out forwards; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden" x-data="studyApp()" :class="{ 'dark': darkMode }">

    <header class="w-full glass-panel sticky top-0 z-50 px-3 py-3 flex items-center justify-between shadow-sm flex-shrink-0 relative">
        <!-- Left: Logo & Theme -->
        <div class="flex items-center gap-2 md:gap-3 z-10">
            <div class="w-3 h-3 rounded-full shadow-sm flex-shrink-0" :class="cameraReady ? 'bg-emerald-400' : 'bg-yellow-400 animate-pulse'"></div>
            <h1 class="hidden sm:block font-bold text-lg md:text-xl tracking-tight bg-gradient-to-r from-pink-500 to-violet-500 bg-clip-text text-transparent">FocusUI</h1>
            <h1 class="sm:hidden font-bold text-lg bg-gradient-to-r from-pink-500 to-violet-500 bg-clip-text text-transparent">‚ú®</h1>
            <button @click="toggleTheme" class="text-lg ml-1 hover:scale-110 transition-transform">
                <span x-show="!darkMode">üåô</span><span x-show="darkMode">‚òÄÔ∏è</span>
            </button>
        </div>

        <!-- Center: Effective Time -->
        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
            <span class="text-[8px] md:text-[10px] uppercase font-bold text-violet-400 tracking-wider">Focus Time</span>
            <span class="text-xl md:text-2xl font-bold tabular-nums leading-none" :class="darkMode ? 'text-violet-300' : 'text-violet-500'" x-text="formatTime(effectiveTime)"></span>
        </div>

        <!-- Right: Timer & Play -->
        <div class="flex items-center gap-3 md:gap-4 z-10">
            <div class="flex flex-col items-end">
                <span class="text-[8px] md:text-[10px] uppercase font-bold text-pink-400 tracking-wider">Timer</span>
                <span class="text-xl md:text-2xl font-bold tabular-nums leading-none" :class="darkMode ? 'text-white' : 'text-slate-700'" x-text="formatTime(timeLeft)"></span>
            </div>
            <button @click="toggleTimer" class="w-10 h-10 md:w-12 md:h-12 rounded-xl md:rounded-2xl flex items-center justify-center shadow-lg transition-all active:scale-95"
                :class="timerRunning ? 'bg-rose-100 text-rose-500' : 'bg-gradient-to-br from-pink-400 to-rose-400 text-white'">
                <svg x-show="!timerRunning" class="h-5 w-5 md:h-6 md:w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3.5v13l11-6.5-11-6.5z"/></svg>
                <svg x-show="timerRunning" class="h-5 w-5 md:h-6 md:w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4h3v12H5V4zm7 0h3v12h-3V4z"/></svg>
            </button>
        </div>
    </header>

    <main class="flex-grow flex flex-col md:flex-row p-3 md:p-6 gap-4 overflow-y-auto no-scrollbar">
        <!-- Video Area: Note the x-ref="videoContainer" which is crucial for the fullscreen logic -->
        <div x-ref="videoContainer" class="flex-grow flex flex-col w-full relative glass-panel rounded-3xl overflow-hidden shadow-xl ring-4 min-h-[300px] md:min-h-0 group" :class="darkMode ? 'ring-white/5' : 'ring-white/30'">
            
            <!-- Controls Overlay: Hidden when controls hidden, but shown on hover or when paused -->
            <div x-show="showControls" x-transition class="absolute top-4 left-4 right-4 z-20 transition-opacity">
                <div class="backdrop-blur-md rounded-xl p-1.5 flex flex-wrap w-full max-w-xl mx-auto shadow-sm border" :class="darkMode ? 'bg-slate-900/90 border-slate-700' : 'bg-white/90 border-white'">
                    <button @click="videoType = 'youtube'" :class="videoType === 'youtube' ? 'bg-pink-100 text-pink-600' : 'text-slate-500'" class="px-3 py-1.5 rounded-lg text-xs font-bold">YouTube</button>
                    <input x-show="videoType === 'youtube'" x-model="youtubeInput" @keyup.enter="loadYoutube" type="text" placeholder="Paste Link..." class="flex-grow bg-transparent border-none focus:ring-0 text-sm px-4 outline-none" :class="darkMode ? 'text-white' : 'text-slate-700'">
                </div>
            </div>

            <!-- Main Video Wrapper -->
            <!-- We apply 'bg-black' here when in fullscreen to ensure letterboxing looks good -->
            <div class="relative w-full h-full flex items-center justify-center video-wrapper" :class="isFullscreen || darkMode ? 'bg-black' : 'bg-slate-100'">
                <template x-if="currentYoutubeId">
                    <!-- Added &fs=0 to disable native fullscreen button -->
                    <iframe :src="`https://www.youtube.com/embed/${currentYoutubeId}?enablejsapi=1&fs=0`" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </template>
                <div x-show="!currentYoutubeId" class="text-center opacity-40">Paste a YouTube link ‚ú®</div>

                <!-- Custom Fullscreen Button (Bottom Right) -->
                <button @click="toggleFullscreen" class="absolute bottom-4 right-4 z-40 p-2 rounded-lg bg-black/50 text-white hover:bg-black/70 backdrop-blur-sm transition-all opacity-0 group-hover:opacity-100">
                    <svg x-show="!isFullscreen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                    <svg x-show="isFullscreen" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H4m0 0v4m0-4l5 5m7-5l5 5m0-5v4m0-4h-6m-6-6l5-5m0 5H4m0 0V4m16 0v4m0-4h-6m0 0l5 5" /></svg>
                </button>

                <!-- Alerts Overlay -->
                <div x-show="alertMessage" class="absolute inset-0 z-30 flex items-center justify-center backdrop-blur-md p-4 bg-black/20">
                    <div class="w-full max-w-xs px-6 py-6 rounded-3xl shadow-2xl border-4 text-center bg-white/90"
                        :class="alertType === 'phone' ? 'border-rose-300 text-rose-500' : 'border-pink-200 text-pink-500'">
                        <h2 class="text-xl font-bold" x-text="alertMessage"></h2>
                    </div>
                </div>

                <!-- Fading Quotes Overlay -->
                <div x-show="fadingMessage" class="absolute bottom-16 left-0 right-0 z-20 flex justify-center pointer-events-none px-4">
                     <div class="animate-message px-6 py-3 rounded-2xl bg-white/90 backdrop-blur-md font-bold text-sm shadow-lg border text-pink-500">
                        <span x-text="fadingMessage"></span> üíñ
                     </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="flex flex-col w-full md:w-64 gap-4 flex-shrink-0">
            <div class="glass-panel rounded-3xl p-3 relative h-40 md:h-auto">
                <video id="input-video" class="w-full h-full object-cover rounded-2xl transform -scale-x-100 opacity-90" playsinline muted></video>
            </div>

            <div class="glass-panel rounded-3xl p-5 flex-grow flex flex-col gap-4 shadow-md">
                <div class="flex gap-1">
                    <template x-for="min in [15, 25, 45]">
                        <button @click="setDuration(min)" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all"
                            :class="selectedDuration === min ? 'bg-pink-400 text-white' : 'bg-pink-50 text-pink-400'" x-text="min + 'm'"></button>
                    </template>
                </div>
                
                <div class="mt-2">
                    <div class="flex justify-between text-[10px] font-bold mb-1">
                        <span class="text-slate-400">Status</span>
                        <span :class="statusColor" x-text="currentStatus"></span>
                    </div>
                    <div class="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-emerald-300 transition-all duration-500" :style="`width: ${cameraReady ? '100%' : '20%'}`"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-auto">
                    <div class="bg-white/50 dark:bg-slate-800/50 rounded-2xl p-3 text-center">
                        <div class="text-[10px] uppercase font-bold text-slate-400">Phone</div>
                        <div class="text-xs font-bold" :class="phoneDetected ? 'text-rose-400' : 'text-emerald-400'" x-text="phoneDetected ? 'YES' : 'NO'"></div>
                    </div>
                    <div class="bg-white/50 dark:bg-slate-800/50 rounded-2xl p-3 text-center">
                        <div class="text-[10px] uppercase font-bold text-slate-400">Focus</div>
                        <div class="text-xs font-bold text-violet-400" x-text="gazeDirection"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>
</html>
